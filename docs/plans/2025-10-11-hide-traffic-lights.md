# Hide Traffic Lights Implementation Plan

> **For Claude:** Use `${CLAUDE_PLUGIN_ROOT}/skills/collaboration/executing-plans/SKILL.md` to implement this plan task-by-task.

**Goal:** Create an Obsidian plugin that permanently hides macOS traffic light buttons by monitoring and re-applying position offsets on key window events.

**Architecture:** Event-driven approach using Obsidian's workspace events (layout-change, window-open, focus) to detect when traffic lights reappear and re-hide them. Electron's `setTrafficLightPosition()` API moves buttons off-screen. Platform detection ensures macOS-only execution. Clean restore on plugin disable.

**Tech Stack:** TypeScript, Obsidian Plugin API, Electron Remote API, esbuild for bundling

---

## Task 1: Project Scaffolding

**Files:**
- Create: `package.json`
- Create: `tsconfig.json`
- Create: `manifest.json`
- Create: `.gitignore`
- Create: `esbuild.config.mjs`

**Step 1: Create package.json**

```json
{
  "name": "hide-traffic-lights",
  "version": "1.0.0",
  "description": "Hide macOS traffic lights in Obsidian",
  "main": "main.js",
  "scripts": {
    "dev": "node esbuild.config.mjs",
    "build": "tsc -noEmit -skipLibCheck && node esbuild.config.mjs production",
    "version": "node version-bump.mjs && git add manifest.json versions.json"
  },
  "keywords": [],
  "author": "Ben",
  "license": "MIT",
  "devDependencies": {
    "@types/node": "^20.10.0",
    "@typescript-eslint/eslint-plugin": "^6.13.0",
    "@typescript-eslint/parser": "^6.13.0",
    "builtin-modules": "^3.3.0",
    "esbuild": "0.19.9",
    "obsidian": "latest",
    "tslib": "2.6.2",
    "typescript": "5.3.2"
  }
}
```

**Step 2: Create tsconfig.json**

```json
{
  "compilerOptions": {
    "baseUrl": ".",
    "inlineSourceMap": true,
    "inlineSources": true,
    "module": "ESNext",
    "target": "ES6",
    "allowJs": true,
    "noImplicitAny": true,
    "moduleResolution": "node",
    "importHelpers": true,
    "isolatedModules": true,
    "strictNullChecks": true,
    "lib": [
      "DOM",
      "ES5",
      "ES6",
      "ES7"
    ]
  },
  "include": [
    "**/*.ts"
  ]
}
```

**Step 3: Create manifest.json**

```json
{
  "id": "hide-traffic-lights",
  "name": "Hide Traffic Lights",
  "version": "1.0.0",
  "minAppVersion": "0.15.0",
  "description": "Hides macOS traffic light buttons for a distraction-free experience",
  "author": "Ben",
  "authorUrl": "",
  "isDesktopOnly": true
}
```

**Step 4: Update .gitignore**

```
# Compiled output
main.js
main.js.map
*.js.map

# Dependencies
node_modules

# Build files
.DS_Store

# Editor
.vscode/
.idea/
```

**Step 5: Create esbuild.config.mjs**

```javascript
import esbuild from "esbuild";
import process from "process";
import builtins from "builtin-modules";

const banner =
`/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
`;

const prod = (process.argv[2] === 'production');

const context = await esbuild.context({
	banner: {
		js: banner,
	},
	entryPoints: ['main.ts'],
	bundle: true,
	external: [
		'obsidian',
		'electron',
		'@codemirror/autocomplete',
		'@codemirror/collab',
		'@codemirror/commands',
		'@codemirror/language',
		'@codemirror/lint',
		'@codemirror/search',
		'@codemirror/state',
		'@codemirror/view',
		'@lezer/common',
		'@lezer/highlight',
		'@lezer/lr',
		...builtins],
	format: 'cjs',
	target: 'es2018',
	logLevel: "info",
	sourcemap: prod ? false : 'inline',
	treeShaking: true,
	outfile: 'main.js',
	minify: prod,
});

if (prod) {
	await context.rebuild();
	process.exit(0);
} else {
	await context.watch();
}
```

**Step 6: Run npm install**

Run: `npm install`
Expected: Dependencies installed successfully

**Step 7: Commit scaffolding**

```bash
git add package.json tsconfig.json manifest.json .gitignore esbuild.config.mjs
git commit -m "feat: add project scaffolding and build setup"
```

---

## Task 2: Core Plugin Implementation

**Files:**
- Create: `main.ts`

**Step 1: Create basic plugin structure**

```typescript
import { Plugin, Platform } from 'obsidian';

export default class HideTrafficLightsPlugin extends Plugin {
	async onload() {
		console.log('Loading Hide Traffic Lights plugin');
	}

	async onunload() {
		console.log('Unloading Hide Traffic Lights plugin');
	}
}
```

**Step 2: Build plugin to verify structure**

Run: `npm run build`
Expected: `main.js` created successfully

**Step 3: Add traffic light hiding function**

```typescript
import { Plugin, Platform } from 'obsidian';

export default class HideTrafficLightsPlugin extends Plugin {
	async onload() {
		console.log('Loading Hide Traffic Lights plugin');

		// Only run on macOS
		if (Platform.isMacOS) {
			this.hideTrafficLights();
		}
	}

	async onunload() {
		console.log('Unloading Hide Traffic Lights plugin');

		// Restore traffic lights on macOS
		if (Platform.isMacOS) {
			this.restoreTrafficLights();
		}
	}

	private hideTrafficLights(): void {
		try {
			const electron = require('electron');
			const window = electron.remote.getCurrentWindow();
			window.setTrafficLightPosition({ x: -100, y: -100 });
		} catch (error) {
			console.error('Failed to hide traffic lights:', error);
		}
	}

	private restoreTrafficLights(): void {
		try {
			const electron = require('electron');
			const window = electron.remote.getCurrentWindow();
			// macOS default position
			window.setTrafficLightPosition({ x: 10, y: 16 });
		} catch (error) {
			console.error('Failed to restore traffic lights:', error);
		}
	}
}
```

**Step 4: Build and verify**

Run: `npm run build`
Expected: Build succeeds with no errors

**Step 5: Commit core implementation**

```bash
git add main.ts
git commit -m "feat: implement basic traffic light hiding/restoring"
```

---

## Task 3: Event-Driven Monitoring

**Files:**
- Modify: `main.ts`

**Step 1: Add debounce utility function**

Add after imports:

```typescript
import { Plugin, Platform, debounce } from 'obsidian';

export default class HideTrafficLightsPlugin extends Plugin {
	private debouncedHide = debounce(
		() => this.hideTrafficLights(),
		50,
		true
	);
```

**Step 2: Register workspace events in onload**

Update the `onload()` method:

```typescript
async onload() {
	console.log('Loading Hide Traffic Lights plugin');

	// Only run on macOS
	if (Platform.isMacOS) {
		// Initial hide
		this.hideTrafficLights();

		// Re-hide on layout changes (debounced to avoid excessive calls)
		this.registerEvent(
			this.app.workspace.on('layout-change', () => {
				this.debouncedHide();
			})
		);

		// Re-hide on window open (multi-window support)
		this.registerEvent(
			this.app.workspace.on('window-open', () => {
				this.hideTrafficLights();
			})
		);

		// Re-hide on window focus
		window.addEventListener('focus', this.hideTrafficLights.bind(this));
		this.register(() => {
			window.removeEventListener('focus', this.hideTrafficLights.bind(this));
		});
	}
}
```

**Step 3: Build and verify**

Run: `npm run build`
Expected: Build succeeds with no TypeScript errors

**Step 4: Commit event monitoring**

```bash
git add main.ts
git commit -m "feat: add event-driven monitoring for traffic lights"
```

---

## Task 4: Documentation

**Files:**
- Create: `README.md`
- Create: `LICENSE`

**Step 1: Create README.md**

```markdown
# Hide Traffic Lights

A simple Obsidian plugin that hides macOS traffic light buttons (red, yellow, green window controls) for a cleaner, distraction-free experience.

## Features

- Automatically hides traffic lights on plugin load
- Monitors window events to keep them hidden during use
- Restores traffic lights when plugin is disabled
- macOS only (does nothing on other platforms)
- Zero configuration needed

## Installation

### From Obsidian Community Plugins (Recommended)

1. Open Settings → Community plugins
2. Search for "Hide Traffic Lights"
3. Click Install, then Enable

### Manual Installation

1. Download the latest release from GitHub
2. Extract `main.js` and `manifest.json` into your vault's plugins folder:
   `VaultFolder/.obsidian/plugins/hide-traffic-lights/`
3. Reload Obsidian
4. Enable the plugin in Settings → Community plugins

## How It Works

The plugin uses Electron's `setTrafficLightPosition()` API to move the traffic light buttons off-screen (position: -100, -100). It monitors these events to re-apply the setting:

- Window focus changes
- Workspace layout changes (pane splits, tab changes)
- New window creation

When you disable the plugin, traffic lights are restored to their default position.

## Development

```bash
# Install dependencies
npm install

# Build plugin
npm run build

# Development mode (auto-rebuild)
npm run dev
```

## Support

If you encounter issues, please report them on [GitHub Issues](https://github.com/yourusername/obsidian-plugin-hide-traffic-lights/issues).

## License

MIT
```

**Step 2: Create LICENSE**

```
MIT License

Copyright (c) 2024 Ben

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
```

**Step 3: Commit documentation**

```bash
git add README.md LICENSE
git commit -m "docs: add README and LICENSE"
```

---

## Task 5: Release Preparation

**Files:**
- Create: `versions.json`
- Create: `version-bump.mjs`
- Create: `.github/workflows/release.yml`

**Step 1: Create versions.json**

```json
{
	"1.0.0": "0.15.0"
}
```

**Step 2: Create version-bump.mjs**

```javascript
import { readFileSync, writeFileSync } from "fs";

const targetVersion = process.env.npm_package_version;

// Update manifest.json
let manifest = JSON.parse(readFileSync("manifest.json", "utf8"));
const { minAppVersion } = manifest;
manifest.version = targetVersion;
writeFileSync("manifest.json", JSON.stringify(manifest, null, "\t"));

// Update versions.json
let versions = JSON.parse(readFileSync("versions.json", "utf8"));
versions[targetVersion] = minAppVersion;
writeFileSync("versions.json", JSON.stringify(versions, null, "\t"));
```

**Step 3: Create GitHub Actions workflow**

Create directory and file:

```bash
mkdir -p .github/workflows
```

Create `.github/workflows/release.yml`:

```yaml
name: Release Obsidian plugin

on:
  push:
    tags:
      - "*"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18.x"

      - name: Build plugin
        run: |
          npm install
          npm run build

      - name: Create release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="${GITHUB_REF#refs/tags/}"

          gh release create "$tag" \
            --title="$tag" \
            --draft \
            main.js manifest.json styles.css
```

**Step 4: Final build test**

Run: `npm run build`
Expected: Clean build with no errors

**Step 5: Commit release files**

```bash
git add versions.json version-bump.mjs .github/workflows/release.yml
git commit -m "chore: add release automation"
```

---

## Testing Checklist

Before creating a release, manually test:

1. **Enable plugin** → Traffic lights should disappear
2. **Disable plugin** → Traffic lights should reappear at normal position
3. **Split pane** → Traffic lights stay hidden
4. **Open settings** → Traffic lights stay hidden
5. **Focus/unfocus window** → Traffic lights stay hidden
6. **Check console** → No errors logged

## Release Process

1. Update version in `package.json`: `npm version patch` (or `minor`/`major`)
2. Push changes: `git push`
3. Create and push tag: `git push origin <version>`
4. GitHub Actions will create draft release
5. Review draft release, add notes, publish

## Success Criteria

✅ Traffic lights hidden on macOS when plugin enabled
✅ Traffic lights restored when plugin disabled
✅ No console errors
✅ Works across window events (focus, layout changes)
✅ Clean build with minified output
✅ Complete documentation
